require=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var EchoClient=module.exports=function(){this.uri=null;this.ws=null;this.lastSentTimestamp=null;this.lastReceivedTimestamp=null;this.cache=null;this.onopen=null;this.onclose=null;this.onerror=null;this.onmessage=null;this.onhistory=null};EchoClient.prototype.open=function(uri){var self=this;function callHandler(event){var handler=self["on"+event];if(typeof handler=="function"){handler.apply(handler,[].slice.call(arguments,1))}}if(this.isOpen()){console.log("error: already open on uri "+this.uri);callHandler("error","already open on uri "+this.uri);return}if(!this.validatePort){console.log("error: invalid port: "+this.port);callHandler("error","invalid port");return}this.uri=uri;this.ws=new WebSocket(uri);this.ws.onopen=function(){callHandler("open")};this.ws.onclose=function(){callHandler("close")};this.ws.onmessage=function(messageEvent){self.lastReceivedTimestamp=(new Date).getTime();var message=JSON.parse(messageEvent.data);message.responseTime=self.lastReceivedTimestamp-self.lastSentTimestamp;if(message.messages.length>1){self.cache=message;callHandler("history",message)}else{self.cache=null;callHandler("message",message)}};this.ws.onerror=function(err){callHandler("error",err)}};EchoClient.prototype.close=function(){if(this.isClosed()){console.log("already closed");return}this.ws.close();this.ws=null;this.uri=null};EchoClient.prototype.isOpen=function(){return this.ws instanceof WebSocket};EchoClient.prototype.isClosed=function(){return!this.isOpen()};EchoClient.prototype.send=function(message){if(!message||!this.isOpen())return;this.lastSentTimestamp=(new Date).getTime();this.ws.send(message)};EchoClient.prototype.sendHistoryCommand=function(){this.send("[HISTORY]")};EchoClient.prototype.historyFilter=function(pattern){if(!this.cache)return[];if(!pattern)return this.cache;var regex=new RegExp(pattern,"i");var filtered=_.filter(this.cache.messages,function(message){return regex.test(message)});return{status:this.cache.status,responseTime:this.cache.responseTime,messages:filtered}};EchoClient.prototype.validatePort=function(port){return port>=1024&&port<65535}},{}],CNGsbw:[function(require,module,exports){var App=require("./models/App");var ServerControlView=require("./views/ServerControlView"),MessagePanelView=require("./views/MessagePanelView");var app=new App;var serverControlView=new ServerControlView({model:app,el:"#server-control"});var messagePanelView=new MessagePanelView({model:app,el:"#message-panel"});module.exports={app:app};app.on("message",function(response){console.log("**************** message: "+response.get("messages")[0])})},{"./models/App":4,"./views/MessagePanelView":6,"./views/ServerControlView":7}],echo:[function(require,module,exports){module.exports=require("CNGsbw")},{}],4:[function(require,module,exports){var EchoClient=require("./../libs/echoclient"),EchoResponse=require("./EchoResponse");var App=Backbone.Model.extend({defaults:{host:"localhost",port:5555,serverState:"stopped"},initialize:function(){this.client=new EchoClient;var self=this;self.client.onopen=function(){console.log("client open");self.trigger("open")};self.client.onclose=function(){console.log("client close");self.client.onopen=null;self.client.onclose=null;self.client.onerror=null;self.client.onmessage=null;self.client.onhistory=null;self.trigger("close")};self.client.onerror=function(err){console.log("client error",err);self.trigger("error",err)};self.client.onmessage=function(response){console.log(response);var er=new EchoResponse(response);console.log(er);self.trigger("message",new EchoResponse(response))};self.client.onhistory=function(response){console.log("client history");self.trigger("history",new EchoResponse(response))};this.checkServerStatus()},validate:function(attrs){if(!this.client.validatePort(attrs.port)){return"invalid port"}},checkServerStatus:function(){var self=this;$.getJSON("/api/v1/echoserver/"+this.get("port"),function(result){if(result&&result.status=="error"){console.log(result);self.set("serverError",result.message);return}if(result&&result.status=="OK"&&/started/.test(result.message)){self.set("serverState","started")}else{self.set("serverState","stopped")}})},startServer:function(){if(!this.isValid())return;this.sendServerCommand("start")},stopServer:function(){if(!this.isValid())return;this.sendServerCommand("stop")},sendServerCommand:function(command){if(!this.isValid())return;this.set("serverError","");var port=this.get("port");var self=this;$.post("/api/v1/echoserver/"+port+"/"+command,function(result){if(result&&result.status=="error"){console.log(result);self.trigger("serverError",result.message);return}console.log("success: "+result.message);self.set("serverState",/started/.test(result.message,"i")?"started":"stopped")})},open:function(){var uri="ws://"+this.get("host")+":"+this.get("port");console.log("client open: "+uri);this.client.open(uri)},close:function(){console.log("client close");this.client.close()},send:function(message){console.log("client send: "+message);this.client.send(message)}});module.exports=App},{"./../libs/echoclient":1,"./EchoResponse":5}],5:[function(require,module,exports){var EchoResponse=Backbone.Model.extend({defaults:{status:"unknown",responseTime:(new Date).getTime(),responseType:"message",messages:[]},toDisplayString:function(){return this.responseType=="message"?this.messages[0]+", "+this.responseTime+"ms":this.responseTime+"ms"}});module.exports=EchoResponse},{}],6:[function(require,module,exports){module.exports=Backbone.View.extend({initialize:function(){this.render();this.listenTo(this.model,"change:serverState",this.render)},template:Handlebars.compile($("#message-panel-template").html()),render:function(){var serverState=this.model.get("serverState");var args={hidden:serverState=="started"?"visible":"hidden"};this.$el.html(this.template(args));return this}})},{}],7:[function(require,module,exports){module.exports=Backbone.View.extend({serverErrorMessage:null,initialize:function(){this.render();this.listenTo(this.model,"change:serverError",this.render);this.listenTo(this.model,"change:serverState",this.render)},events:{"click #btnserver":"togglestart"},template:Handlebars.compile($("#server-control-template").html()),render:function(){var port=this.model.get("port");var serverState=this.model.get("serverState");var serverStateText=serverState=="started"?"started (port "+port+")":serverState;var serverError=this.model.get("serverError");var serverErrorClass=serverError?"visible":"hidden";var args={stateClass:serverState,serverState:serverStateText,serverPort:port,inputVisibility:serverState=="started"?"collapse":"visible",serverCommand:serverState=="started"?"Stop":"Start",serverErrorClass:serverErrorClass,serverErrorMessage:serverError};this.$el.html(this.template(args));return this},port:function(){return $("#portnumber").val()},togglestart:function(){var port=this.port();this.model.set("port",port,{validate:true});if(this.model.validationError){$("#portnumber").val("");return}var command=this.model.get("serverState")=="started"?"stop":"start";this.model.sendServerCommand(command)}})},{}]},{},[]);