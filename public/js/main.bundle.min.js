require=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var EchoClient=module.exports=function(){this.uri=null;this.ws=null;this.lastSentTimestamp=null;this.lastReceivedTimestamp=null;this.cache=null;this.onopen=null;this.onclose=null;this.onerror=null;this.onmessage=null;this.onhistory=null};EchoClient.prototype.open=function(uri){var self=this;function callHandler(event){var handler=self["on"+event];if(typeof handler=="function"){handler.apply(handler,[].slice.call(arguments,1))}}if(this.isOpen()){console.log("error: already open on uri "+this.uri);callHandler("error","already open on uri "+this.uri);return}if(!this.validatePort){console.log("error: invalid port: "+this.port);callHandler("error","invalid port");return}this.uri=uri;this.ws=new WebSocket(uri);this.ws.onopen=function(){callHandler("open")};this.ws.onclose=function(){callHandler("close")};this.ws.onmessage=function(messageEvent){self.lastReceivedTimestamp=(new Date).getTime();var message=JSON.parse(messageEvent.data);message.responseTime=self.lastReceivedTimestamp-self.lastSentTimestamp;if(message.messageType=="history"){self.cache=message;callHandler("history",message)}else{self.cache=null;callHandler("message",message)}};this.ws.onerror=function(err){callHandler("error",err)}};EchoClient.prototype.close=function(){if(this.isClosed()){console.log("already closed");return}this.ws.close();this.ws=null;this.uri=null};EchoClient.prototype.isOpen=function(){return this.ws instanceof WebSocket};EchoClient.prototype.isClosed=function(){return!this.isOpen()};EchoClient.prototype.send=function(message){if(!message||!this.isOpen())return;this.lastSentTimestamp=(new Date).getTime();this.ws.send(message)};EchoClient.prototype.sendHistoryCommand=function(){this.send("[HISTORY]")};EchoClient.prototype.historyFilter=function(pattern){if(!this.cache)return[];if(!pattern)return this.cache;var regex=new RegExp(pattern,"i");var filtered=_.filter(this.cache.messages,function(message){return regex.test(message)});return{status:this.cache.status,responseTime:this.cache.responseTime,messages:filtered}};EchoClient.prototype.validatePort=function(port){return port>=1024&&port<65535}},{}],CNGsbw:[function(require,module,exports){var App=require("./models/App");var ServerControlView=require("./views/ServerControlView"),MessagePanelView=require("./views/MessagePanelView");var app=new App;var serverControlView=new ServerControlView({model:app,el:"#server-control"});var messagePanelView=new MessagePanelView({model:app,el:"#message-panel"});module.exports={app:app}},{"./models/App":4,"./views/MessagePanelView":7,"./views/ServerControlView":10}],echo:[function(require,module,exports){module.exports=require("CNGsbw")},{}],4:[function(require,module,exports){var EchoClient=require("./../libs/echoclient"),EchoResponse=require("./EchoResponse");var App=Backbone.Model.extend({defaults:{host:"localhost",port:5555,serverState:"stopped"},initialize:function(){this.client=new EchoClient;var self=this;self.client.onopen=function(){console.log("client open");self.trigger("open")};self.client.onclose=function(){console.log("client close");self.client.onopen=null;self.client.onclose=null;self.client.onerror=null;self.client.onmessage=null;self.client.onhistory=null;self.trigger("close")};self.client.onerror=function(err){console.log("client error",err);self.trigger("error",err)};self.client.onmessage=function(response){console.log(response);var er=new EchoResponse(response);self.trigger("message",er)};self.client.onhistory=function(response){console.log("client history");self.trigger("history",new EchoResponse(response))};this.checkServerStatus()},validate:function(attrs){if(!this.client.validatePort(attrs.port)){return"invalid port"}},checkServerStatus:function(){var self=this;$.getJSON("/api/v1/echoserver/"+this.get("port"),function(result){if(result&&result.status=="error"){console.log(result);self.trigger("serverError",result.message);return}if(result&&result.status=="OK"&&/started/.test(result.message)){self.set("serverState","started")}else{self.set("serverState","stopped")}})},startServer:function(){if(!this.isValid())return;this.sendServerCommand("start")},stopServer:function(){if(!this.isValid())return;this.sendServerCommand("stop")},sendServerCommand:function(command){if(!this.isValid())return;this.set("serverError","");var port=this.get("port");var self=this;$.post("/api/v1/echoserver/"+port+"/"+command,function(result){if(result&&result.status=="error"){console.log(result);self.trigger("serverError",result.message);return}console.log("success: "+result.message);var started=/started/.test(result.message,"i");if(started){self.set("serverState","started");self.open()}else{self.set("serverState","stopped");self.close()}})},open:function(){var uri="ws://"+this.get("host")+":"+this.get("port");console.log("client open: "+uri);this.client.open(uri)},close:function(){console.log("client close");this.client.close()},send:function(message){if(!this.client.isOpen())return;console.log("client send: "+message);this.client.send(message)}});module.exports=App},{"./../libs/echoclient":1,"./EchoResponse":5}],5:[function(require,module,exports){var EchoResponse=Backbone.Model.extend({defaults:{status:"",responseTime:(new Date).getTime(),responseType:"message",messages:[""]},toDisplayString:function(){return this.get("responseType")!="message"?this.get("responseTime")+"ms":this.get("messages")[0]+", "+this.get("responseTime")+"ms"}});module.exports=EchoResponse},{}],6:[function(require,module,exports){module.exports=Backbone.View.extend({initialize:function(){this.render()},template:Handlebars.compile($("#message-history-template").html()),render:function(){var args={};this.$el.html(this.template(args));return this}})},{}],7:[function(require,module,exports){var MessageSendView=require("./MessageSendView"),MessageReceiveView=require("./MessageReceiveView"),MessageHistoryView=require("./MessageHistoryView");module.exports=Backbone.View.extend({initialize:function(){this.sendView=new MessageSendView({model:this.model});this.receiveView=new MessageReceiveView({model:this.model});this.historyView=new MessageHistoryView({model:this.model});this.render();this.listenTo(this.model,"change:serverState",this.render)},template:Handlebars.compile($("#message-panel-template").html()),render:function(){var serverState=this.model.get("serverState");var args={hidden:serverState=="started"?"visible":"collapse"};this.$el.html(this.template(args));this.sendView.setElement(this.$("#message-send")).render();this.receiveView.setElement(this.$("#message-receive")).render();this.historyView.setElement(this.$("#message-history")).render();return this}})},{"./MessageHistoryView":6,"./MessageReceiveView":8,"./MessageSendView":9}],8:[function(require,module,exports){var EchoResponse=require("./../models/EchoResponse");module.exports=Backbone.View.extend({initialize:function(){var self=this;this.render();this.model.on("message history",function(response){self.render(response)})},template:Handlebars.compile($("#message-receive-template").html()),render:function(){var response=arguments[0];if(!(response instanceof EchoResponse))return;var args={message:response.toDisplayString()};this.$el.html(this.template(args));return this}})},{"./../models/EchoResponse":5}],9:[function(require,module,exports){module.exports=Backbone.View.extend({initialize:function(){this.render();this.$(".btn").bind("input",function(){if($(this).val()){console.log("value");$("#btnsendmessage").removeClass("disabled")}else{console.log("empty");$("#btnsendmessage").addClass("disabled")}})},events:{"click #btnsendmessage":"sendMessage"},template:Handlebars.compile($("#message-send-template").html()),render:function(){var args={};this.$el.html(this.template(args));return this},messageText:function(){return $("#message").val()},sendMessage:function(){var message=this.messageText();this.model.send(message)}})},{}],10:[function(require,module,exports){module.exports=Backbone.View.extend({serverErrorMessage:null,initialize:function(){var self=this;this.render();this.listenTo(this.model,"change:serverState",this.render);this.model.on("serverError",function(err){self.serverError=err;self.render()})},events:{"click #btnserver":"togglestart"},template:Handlebars.compile($("#server-control-template").html()),render:function(){var port=this.model.get("port");var serverState=this.model.get("serverState");var serverStateText=serverState=="started"?"started (port "+port+")":serverState;var serverError=this.serverError?" Error: "+this.serverError:null;var serverErrorClass=serverError?"visible":"hidden";var args={stateClass:serverState,serverState:serverStateText,serverPort:port,inputVisibility:serverState=="started"?"collapse":"visible",serverCommand:serverState=="started"?"Stop":"Start",serverErrorClass:serverErrorClass,serverError:serverError};this.$el.html(this.template(args));$("#portnumber").focus();return this},port:function(){return $("#portnumber").val()},togglestart:function(){this.serverError=null;$("#server-error").html("");var port=this.port();this.model.set("port",port,{validate:true});if(this.model.validationError){$("#portnumber").val("");return}var command=this.model.get("serverState")=="started"?"stop":"start";this.model.sendServerCommand(command)}})},{}]},{},[]);